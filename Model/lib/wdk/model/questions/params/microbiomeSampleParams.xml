<?xml version="1.0" encoding="utf-8"?>
<wdkModel>

  <!-- notes

     - should ms_assay param be a controlled vocab pulled from the database?

  -->

  <paramSet name="sampleParams">

    <!--++++++++++++++++++++++++++++++++++++++++++++++++-->
    <!-- ID -->
    <!--++++++++++++++++++++++++++++++++++++++++++++++++-->
  
      <datasetParam name="sample_id" prompt="Sample ID" 
                      recordClassRef="SampleRecordClasses.MicrobiomeSampleRecordClass" >
            <help>Input a comma delimited set of  Sample IDs, or upload a file. Wildcards (*) are allowed.</help>
             <suggest includeProjects="MicrobiomeDB"
                     default="EUSMPL0020-1-26"/>
          </datasetParam>

       <flatVocabParam name="metadata_datasets"
                     queryRef="samplesVQ.MicrobiomeDatasets"
                     prompt="Dataset"
                     quote="true"
                     visible="true"
                     multiPick="true">
            <help>Choose an Experiment</help> 
            <suggest selectMode="all" />
       </flatVocabParam>

       <filterParamNew name="samples_filter_metadata" includeProjects="MicrobiomeDB" 
                      metadataQueryRef="samplesVQ.SamplesMetadata"
                      ontologyQueryRef="samplesVQ.MetadataSpec"
                      prompt="Samples"
                      dependedParamRef="sampleParams.metadata_datasets">
         <help>
              Select reference samples. 
         </help>
         <!-- <suggest selectMode="all" /> -->
       </filterParamNew>

       <filterParamNew name="samples_filter_taxon" includeProjects="MicrobiomeDB" 
                      metadataQueryRef="samplesVQ.SamplesTaxon"
                      ontologyQueryRef="samplesVQ.SamplesTaxonSpec"
                      prompt="Taxon Relative Abundance"
                      dependedParamRef="sampleParams.metadata_datasets">
         <help>
              Select reference samples. 
         </help>
         <!-- <suggest selectMode="all" /> -->
       </filterParamNew>
    
  </paramSet>

  <querySet name="samplesVQ" queryType="vocab" isCacheable="true">


       <sqlQuery name="MicrobiomeDatasets" excludeProjects="EuPathDB">
             <column name="internal"/>
             <column name="term"/>
             <column name="display"/>
          <sql>
             select distinct dsp.name AS internal, dsp.name as term,
                    display_name AS display
             from apidbTuning.DatasetPresenter dsp
             where dsp.name like 'otu_%_RSRC'
             order by display_name asc
          </sql>
        </sqlQuery>

        <sqlQuery name="SamplesTaxon" doNotTest="1" includeProjects="MicrobiomeDB">
          <paramRef ref="sampleParams.metadata_datasets"/>
          <column name="ontology_term_name"/>
          <column name="internal"/>
          <column name="internal_for_counts"/>
          <column name="number_value"/>
          <column name="date_value"/>
          <column name="string_value"/>
          <sql>
            <![CDATA[
                select protocol_app_node_id as internal,
                       protocol_app_node_id as internal_for_counts,
                       term_id as ontology_term_name,
                       cast(value as number) as number_value,
                       cast(null as date) as date_value,
                       cast(null as varchar2(1)) as string_value
                from apidbTuning.TaxonAbundance
                where dataset_name in ($$metadata_datasets$$)
--                and value is not null
                order by taxon_level
            ]]>
            </sql>
        </sqlQuery>

    <sqlQuery name="SamplesTaxonSpec" doNotTest="1" includeProjects="MicrobiomeDB"> 
            <paramRef ref="sampleParams.metadata_datasets"/>
            <column name="ontology_term_name"/>
            <column name="parent_ontology_term_name"/>
            <column name="display_name"/>
            <column name="description"/>
            <column name="type"/>
            <column name="units"/>
            <column name="precision"/>
            <column name="is_range"/>
            <sql>
              <![CDATA[
                  select distinct -- unneeded only because of UNION
                         category as ontology_term_name,
                         cast(null as varchar2(1)) as parent_ontology_term_name,
                         category as display_name,
                         'taxonomic rank' as description,
                         'string' as type, cast(null as varchar2(1)) as units,
                         1 as precision, 0 as is_range,
                         taxon_level * 2 - 1 as ordering
                  from apidbTuning.TaxonAbundance
                  where dataset_name in ($$metadata_datasets$$)
                union
                  select term_id as ontology_term_name,
                         category as parent_ontology_term_name,
                         term as display_name,
                         cast(null as varchar2(1)) as description,
                         'number' as type, null as units, 1 as precision, 1 as is_range,
                         taxon_level * 2 as ordering
                  from apidbTuning.TaxonAbundance
                  where dataset_name in ($$metadata_datasets$$)
                order by ordering
              ]]>
            </sql>
        </sqlQuery>

    <sqlQuery name="SamplesWithMetadata" excludeProjects="EuPathDB">
         <paramRef ref="sampleParams.metadata_datasets"/>
         <column name="internal"/>
         <column name="term"/>
         <column name="display"/>
         <sql>
           select * from (
              select pan_name as term, pan_name as display, protocol_app_node_id as internal
              from apidbTuning.panCharacteristicMetadata
              where dataset_name in ($$metadata_datasets$$)
              and pan_name not like '%[alpha_diversity]%'
              union
              select pan_name as term, pan_name as display, protocol_app_node_id as internal
              from apidbTuning.panProtocolMetadata
              where dataset_name in ($$metadata_datasets$$)
              union
              select pan_name as term, pan_name as display, protocol_app_node_id as internal
              from apidbTuning.FallbackMetadata
              where dataset_name in ($$metadata_datasets$$))
            where term not like '%[alpha_diversity]%' 
          </sql>
        </sqlQuery>

        <sqlQuery name="SamplesMetadata" doNotTest="1" excludeProjects="EuPathDB">
          <paramRef ref="sampleParams.metadata_datasets"/>
          <column name="ontology_term_name"/>
          <column name="internal"/>
          <column name="internal_for_counts"/>
          <column name="number_value"/>
          <column name="date_value"/>
          <column name="string_value"/>
          <sql>
            <![CDATA[
            select md.pan_id as internal, md.pan_id as internal_for_counts,
                   md.property as ontology_term_name,
                   cast(case
                          when pt.type = 'number' and apidb.is_number(md.value) = 1
                            then apidb.parse_and_round_number(md.value)
                          else null
                        end as number) as number_value,
                  case
                    when pt.type = 'string'
                      then md.value
                    else cast(null as varchar2(10))
                  end as string_value,
                  cast(case
                         when pt.type = 'date'
                           then apidb.parse_date(md.value)
                         else null
                       end as date) as date_value
               from (  select pan_id, property, value
                       from apidbtuning.InferredChars
                       where dataset_name in ($$metadata_datasets$$)
                     union
                       select pan_id, property, value
                       from apidbtuning.InferredParams
                       where dataset_name in ($$metadata_datasets$$)
                     union
                       select pan_id, property, value
                       from apidbtuning.DefaultChars
                       where dataset_name in ($$metadata_datasets$$)
                    ) md,
                    (select property, max(type) as type
                     from apidbTuning.PropertyType
                     group by property) pt
               where pt.property = md.property
            ]]>
            </sql>
        </sqlQuery>

    <sqlQuery name="MetadataSpec" doNotTest="1" excludeProjects="EuPathDB"> 
            <paramRef ref="sampleParams.metadata_datasets"/>
            <column name="ontology_term_name"/>
            <column name="parent_ontology_term_name"/>
            <column name="display_name"/>
            <column name="description"/>
            <column name="type"/>
            <column name="units"/>
            <column name="precision"/>
            <column name="is_range"/>
            <sql>
              <![CDATA[
                select distinct ontology_term_name, parent_ontology_term_name, display_name,
                       description, type, units, precision, is_range
                from apidbTuning.Ontology
                where dataset_name in ($$metadata_datasets$$)
              ]]>
            </sql>
        </sqlQuery>

 
  </querySet>


</wdkModel>
